<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实验3 开源WebGIS开发基础</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/Leaflet.ChineseTmsProviders/src/leaflet.ChineseTmsProviders.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <style>
        #map { width: 100vw; height: 90vh; border: 1px solid #ccc; }
        .tool-bar { position: fixed; top: 20px; right: 20px; z-index: 1000; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tool-bar button { display: block; width: 120px; padding: 8px 0; margin: 5px 0; border: none; border-radius: 4px; background: #0078A8; color: white; cursor: pointer; }
        .tool-bar button:hover { background: #005F87; }
        h1 { text-align: center; margin: 10px 0; color: #333; }
    </style>
</head>
<body>
    <h1>地图</h1>
    <div id="map"></div>
    <div class="tool-bar">
        <button id="showGeoServer">显示GeoServer图层</button>
        <button id="hideGeoServer">隐藏GeoServer图层</button>
        <button id="clearDraw">清除所有绘制图形</button>
    </div>

    <script>
        var map = L.map('map', {
            center: [39.914885, 116.403874],
            zoom: 10
        });
        var tiandituKey = '1372e63bb5edd06a0e945207d8088b84';

        // 矢量底图
        var tiandituVector = L.tileLayer.chinaProvider('TianDiTu.Normal.Map', {
            maxZoom: 18,
            minZoom: 5,
            key: tiandituKey,
            protocol: 'https'
        });
        var tiandituVectorLabel = L.tileLayer.chinaProvider('TianDiTu.Normal.Annotion', {
            maxZoom: 18,
            minZoom: 5,
            key: tiandituKey,
            protocol: 'https'
        });
        var tiandituVectorGroup = L.layerGroup([tiandituVector, tiandituVectorLabel]).addTo(map);

        // 影像底图 
        const tiandituImage = L.tileLayer.chinaProvider('TianDiTu.Satellite.Map', {
            maxZoom: 18,
            minZoom: 5,
            key: tiandituKey,
            protocol: 'https'
        });
        const tiandituImageLabel = L.tileLayer.chinaProvider('TianDiTu.Satellite.Annotion', {
            maxZoom: 18,
            minZoom: 5,
            key: tiandituKey,
            protocol: 'https'
        });
        const tiandituImageGroup = L.layerGroup([tiandituImage, tiandituImageLabel]);

        // 底图切换控件
        const baseLayers = {
            "天地图矢量底图（含注记）": tiandituVectorGroup,
            "天地图影像底图（含注记）": tiandituImageGroup
        };
        L.control.layers(baseLayers).addTo(map);

        // 加载GeoServer图层
        const geoServerLayer = L.tileLayer.wms("http://localhost:8080/geoserver/wms", {
            layers: "qianhang:China", 
            styles: "", 
            format: "image/png", 
            transparent: true, 
            version: "1.3.0", 
            attribution: "自定义图层（GeoServer发布）"
        });

        // 绘图控件
        const drawControl = new L.Control.Draw({
            draw: { marker: true, polyline: true, polygon: true, rectangle: false, circle: false, circlemarker: false },
            edit: { featureGroup: L.featureGroup().addTo(map), remove: true }
        }).addTo(map);

        map.on(L.Draw.Event.CREATED, function (e) {
            const layer = e.layer;
            L.featureGroup().addTo(map).addLayer(layer);
        });

        // 按钮事件
        document.getElementById('showGeoServer').addEventListener('click', function() {
            map.addLayer(geoServerLayer);
            alert("GeoServer图层已显示！");
        });

        document.getElementById('hideGeoServer').addEventListener('click', function() {
            map.removeLayer(geoServerLayer);
            alert("GeoServer图层已隐藏！");
        });

        document.getElementById('clearDraw').addEventListener('click', function() {
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker || layer instanceof L.Polyline || layer instanceof L.Polygon) {
                    map.removeLayer(layer);
                }
            });
            alert("所有绘制图形已清除！");
        });
    </script>
</body>
</html>